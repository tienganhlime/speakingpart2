<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCE Speaking Part 2 - LIME</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); min-height: 100vh; }
    .fade-in { animation: fadeIn 0.5s ease-in; } @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .images { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .images img { width: 45%; min-width: 200px; max-width: 400px; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; }
    .timer { font-size: 1.5em; font-weight: bold; color: #dc2626; }
    .small-btn { @apply px-3 py-1 text-sm font-medium bg-gray-600 hover:bg-gray-700 text-white rounded-lg; }
    .placeholder-img { background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body class="p-4">
<div id="app" class="max-w-4xl mx-auto">
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen fade-in">
    <div class="bg-white rounded-2xl shadow-2xl p-8 mt-8">
      <div class="text-center mb-8">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-32 h-32 mx-auto mb-4 object-contain">
        <h1 class="text-4xl font-bold text-green-700 mb-2">Trung Tâm Tiếng Anh LIME</h1>
        <p class="text-green-600 text-lg">Hotline: 0976222792</p>
        <div class="mt-4 h-1 w-32 bg-green-500 mx-auto rounded"></div>
      </div>
      <div class="bg-green-50 rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-green-800 mb-4">FCE SPEAKING PART 2</h2>
        <p class="text-green-700">So sánh 2 ảnh + trả lời câu hỏi trong 1 phút</p>
        <p class="text-green-700">AI chấm theo FCE rubric</p>
        <p class="text-green-700">Leaderboard: Tổng điểm + Trung bình</p>
      </div>
      <label class="block text-green-800 font-semibold mb-2">Mã học sinh *</label>
      <input type="text" id="studentCode" class="w-full px-4 py-3 border-2 border-green-300 rounded-lg uppercase text-lg" placeholder="VD: HS001" />
      <button onclick="verifyStudent()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg shadow-lg">
        XÁC NHẬN & BẮT ĐẦU
      </button>
    </div>
  </div>

  <!-- EXAM SCREEN -->
  <div id="examScreen" class="hidden min-h-screen pb-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
          <div>
            <h1 class="text-2xl font-bold text-green-700">FCE Speaking Part 2</h1>
            <p class="text-green-600 text-sm">Xin chào, <span id="studentName"></span>!</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">Mã: <span id="headerCode"></span></p>
          <p class="text-sm text-gray-600">Mục tiêu: <span id="targetLevel"></span></p>
          <div class="timer" id="timer">01:00</div>
        </div>
      </div>
      <div class="mt-4 flex gap-2 justify-end">
        <button onclick="showLeaderboard()" class="small-btn">Bảng xếp hạng</button>
        <button onclick="logout()" class="small-btn">Đăng xuất</button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6 fade-in">
      <div class="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white px-6 py-4 rounded-t-xl -mx-8 -mt-8 mb-6">
        <h2 class="text-2xl font-bold">So sánh 2 bức tranh</h2>
      </div>
      <div class="images mb-6" id="images"></div>
      <p class="text-lg font-semibold text-indigo-800 mb-6 p-4 bg-indigo-50 rounded-lg" id="question"></p>

      <div class="flex gap-3 flex-wrap mb-4">
        <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Bắt đầu ghi âm</button>
        <button id="stopBtn" disabled class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg">Dừng</button>
        <button id="submitBtn" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Gửi AI chấm</button>
      </div>

      <div class="mt-6 p-4 bg-gray-50 rounded-lg" id="transcript">Nhấn "Bắt đầu ghi âm" để nói...</div>
      <div id="result" class="mt-6"></div>

      <label class="flex items-center gap-2 mt-6 text-gray-700">
        <input type="checkbox" id="saveAudio" checked /> Lưu audio?
      </label>

      <button onclick="restartExam()" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">
        Làm bài mới
      </button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardScreen" class="hidden min-h-screen pb-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-green-700">BẢNG XẾP HẠNG</h1>
      <button onclick="hideLeaderboard()" class="small-btn">Quay lại</button>
    </div>
    <div class="bg-white rounded-2xl shadow-2xl p-6 overflow-x-auto">
      <table class="w-full table-auto border-collapse">
        <thead>
          <tr class="bg-green-100 text-green-800">
            <th class="p-3 text-left">Hạng</th>
            <th class="p-3 text-left">Học sinh</th>
            <th class="p-3 text-center">Tổng điểm</th>
            <th class="p-3 text-center">Số bài</th>
            <th class="p-3 text-center">Trung bình</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// === CẤU HÌNH ===
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYlENWgtwewFblT0mdbrK-TuN8S1QEI0y_MgoqAmNy6okRTHLbmV8gIjgIFHJdaSGlrg/exec'; // THAY BẰNG URL CỦA BẠN

let student = {}, recognition, mediaRecorder, audioBlob, transcript = '', currentQuestion = '', startTime, timerInterval, timeLeft = 60;

// === 25 CẶP ẢNH ===
const questions = [
  // 1. Teamwork
  {
    img1: "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1552664730-d307ca884978?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why teamwork might be important in these situations."
  },
  // 2. Emotions/Feelings
  {
    img1: "https://images.unsplash.com/photo-1524594152308-39a3c8dc4d9a?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the people might be feeling."
  },
  // 3. Music Listening
  {
    img1: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1579586144127-4334a3b6b9c5?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what kind of music the people might be listening to."
  },
  // 4. Outdoor Activities
  {
    img1: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might have chosen these activities."
  },
  // 5. Appearance/Fashion
  {
    img1: "https://images.unsplash.com/photo-1445205170230-053b83016050?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1542272604-787c38355395?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the people might be feeling about their appearance."
  },
  // 6. Celebration/Party
  {
    img1: "https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1519455953755-9d11a8e6d19c?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the people might be celebrating."
  },
  // 7. Transport Vehicles
  {
    img1: "https://images.unsplash.com/photo-1502877338535-766e3a6052db?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might be using these forms of transport."
  },
  // 8. Technology Work
  {
    img1: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how technology might be helping the people in their work."
  },
  // 9. Shopping/Buying
  {
    img1: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1571771894821-ce9b6c747b4e?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the people might be buying and why."
  },
  // 10. Learning/Education
  {
    img1: "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the people might be learning in these situations."
  },
  // 11. Photography/Taking Photos
  {
    img1: "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might be taking these photos."
  },
  // 12. After Activities/Relaxation
  {
    img1: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1445205170230-053b83016050?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the people might be doing after these activities."
  },
  // 13. Weather Effect on People
  {
    img1: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the weather might be affecting the people."
  },
  // 14. Fashion Clothes
  {
    img1: "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1554151228-14d9def656e4?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might have chosen these clothes."
  },
  // 15. Hiking Outdoor
  {
    img1: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1517248135467-2c7ed3ed2b5a?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the disadvantages might be of these situations."
  },
  // 16. Travel Alone
  {
    img1: "https://images.unsplash.com/photo-1502877338535-766e3a6052db?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might prefer these places."
  },
  // 17. Sports Exercise
  {
    img1: "https://images.unsplash.com/photo-1524504388944-b46d3b0f9f75?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the people might be learning."
  },
  // 18. School Students
  {
    img1: "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the activities might affect their health."
  },
  // 19. Reading Books
  {
    img1: "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1497633762265-9d179a990aa6?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why these people might be happy."
  },
  // 20. Cooking Food
  {
    img1: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1551218808-94e220e084d0?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the people might do next."
  },
  // 21. Painting Art
  {
    img1: "https://images.unsplash.com/photo-1571113758179-48a7a8f383b2?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the environments might influence the people."
  },
  // 22. Dancing Party
  {
    img1: "https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1519455953755-9d11a8e6d19c?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why the people might be tired."
  },
  // 23. Cycling Bike
  {
    img1: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say what the similarities are in their daily routines."
  },
  // 24. Gardening Plants
  {
    img1: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say how the people might prepare for these events."
  },
  // 25. Swimming Pool
  {
    img1: "https://images.unsplash.com/photo-1551632811-561732d1e306?w=400&h=300&fit=crop",
    img2: "https://images.unsplash.com/photo-1572492047507-e6361c7a4a6e?w=400&h=300&fit=crop",
    question: "Compare the two pictures and say why teamwork might be important here."
  }
];

// === KHỞI ĐỘNG ===
function initApp() {
  const saved = localStorage.getItem('speakingStudent');
  if (saved) {
    try {
      student = JSON.parse(saved);
      fetch(`${GOOGLE_SCRIPT_URL}?action=verifySpeaking&code=${student.code}`)
        .then(r => r.json())
        .then(data => data.exists && data.name === student.name ? showExam() : showLogin())
        .catch(() => showLogin());
    } catch { showLogin(); }
  } else showLogin();
}

function showLogin() {
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('examScreen').classList.add('hidden');
  document.getElementById('leaderboardScreen').classList.add('hidden');
}

function showExam() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('examScreen').classList.remove('hidden');
  document.getElementById('leaderboardScreen').classList.add('hidden');
  document.getElementById('studentName').textContent = student.name;
  document.getElementById('headerCode').textContent = student.code;
  document.getElementById('targetLevel').textContent = student.target;
  loadQuestion();
  resetTimer();
}

// === ĐĂNG NHẬP ===
async function verifyStudent() {
  const input = document.getElementById('studentCode');
  let code = input.value;
  
  if (!code) {
    alert('Vui lòng nhập mã học sinh!');
    return;
  }
  
  // Chuẩn hóa mã: loại bỏ khoảng trắng, viết hoa
  code = code.trim().toUpperCase();
  console.log('Mã sau khi chuẩn hóa:', code); // DEBUG
  
  // Tìm button để disable
  const btn = document.querySelector('#loginScreen button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Đang xác nhận...';

  try {
    const url = `${GOOGLE_SCRIPT_URL}?action=verifySpeaking&code=${encodeURIComponent(code)}`;
    console.log('Đang gọi API:', url); // DEBUG
    
    const res = await fetch(url);
    const data = await res.json();
    console.log('API trả về:', data); // DEBUG
    
    if (data.exists) {
      student = { 
        code: code, // Dùng code đã chuẩn hóa
        name: data.name, 
        target: data.target || 'B1' 
      };
      localStorage.setItem('speakingStudent', JSON.stringify(student));
      showExam();
    } else {
      alert(`Không tìm thấy mã học sinh: ${code}\n\nVui lòng kiểm tra lại hoặc liên hệ giáo viên.`);
      input.focus();
      input.select();
    }
  } catch (err) {
    console.error('Lỗi kết nối:', err);
    alert('Lỗi kết nối! Vui lòng:\n• Kiểm tra Internet\n• Thử lại sau vài giây\n• Liên hệ admin nếu lỗi liên tục');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}
function logout() { localStorage.removeItem('speakingStudent'); location.reload(); }

// === TẢI CÂU HỎI ===
function loadQuestion() {
  const q = questions[Math.floor(Math.random() * questions.length)];
  document.getElementById('images').innerHTML = `
    <img src="${q.img1}" alt="1" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Found'; this.classList.add('placeholder-img')">
    <img src="${q.img2}" alt="2" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Found'; this.classList.add('placeholder-img')">
  `;
  document.getElementById('question').textContent = q.question;
  currentQuestion = q.question;
}

// === TIMER ===
function startTimer() {
  timeLeft = 60;
  document.getElementById('timer').textContent = '01:00';
  document.getElementById('timer').className = 'timer text-green-600';
  timerInterval = setInterval(() => {
    timeLeft--;
    const display = `00:${timeLeft.toString().padStart(2, '0')}`;
    document.getElementById('timer').textContent = display;
    if (timeLeft <= 0) {
      document.getElementById('timer').textContent = '00:00';
      document.getElementById('timer').className = 'timer text-red-600 font-bold';
      document.getElementById('timer').innerHTML += ' <span class="text-sm">(Quá giờ!)</span>';
      clearInterval(timerInterval);
    }
  }, 1000);
}
function resetTimer() { clearInterval(timerInterval); document.getElementById('timer').textContent = '01:00'; document.getElementById('timer').className = 'timer text-green-600'; }

// === GHI ÂM ===
document.getElementById('startBtn').onclick = () => {
  transcript = '';
  document.getElementById('transcript').textContent = 'Đang nghe... (Nói tiếng Anh!)';
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  document.getElementById('submitBtn').disabled = true;
  startTime = Date.now();
  startTimer();

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-GB';
  recognition.interimResults = true;
  recognition.continuous = true;
  recognition.onresult = e => {
    transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
    document.getElementById('transcript').textContent = transcript;
  };
  recognition.start();

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(chunks, { type: 'audio/webm' });
      document.getElementById('submitBtn').disabled = false;
    };
    mediaRecorder.start();
  }).catch(() => {
    alert('Cần cấp quyền micro!');
    document.getElementById('startBtn').disabled = false;
  });
};

document.getElementById('stopBtn').onclick = () => {
  recognition?.stop();
  mediaRecorder?.stop();
  clearInterval(timerInterval);
  document.getElementById('stopBtn').disabled = true;
  document.getElementById('submitBtn').disabled = false;
};

// === GỬI + LẤY KẾT QUẢ ===
document.getElementById('submitBtn').onclick = async () => {
  const duration = Math.round((Date.now() - startTime) / 1000);
  const saveAudio = document.getElementById('saveAudio').checked;

  let audioBase64 = '';
  if (saveAudio && audioBlob) {
    audioBase64 = await blobToBase64(audioBlob);
  }

  const dataToSend = {
    action: 'submitSpeaking',
    studentCode: student.code,
    studentName: student.name,
    targetLevel: student.target,
    transcript,
    question: currentQuestion,
    duration,
    audioBase64
  };

  document.getElementById('result').innerHTML = '<div class="spinner mr-2"></div> Đang gửi...';

  try {
    await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(dataToSend)
    });

    setTimeout(async () => {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLatestScore&code=${student.code}`);
      const ai = await res.json();
      document.getElementById('result').innerHTML = `
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
          <h3 class="text-xl font-bold text-green-700 mb-2">Kết quả AI</h3>
          <p><strong>Điểm:</strong> ${ai.score || 'N/A'}/10 | <strong>CEFR:</strong> ${ai.cefrEquivalent || 'N/A'}</p>
          <p><strong>Phản hồi:</strong> ${ai.feedback || 'Đang xử lý...'}</p>
        </div>
      `;
      showLeaderboard();
    }, 3000);
  } catch {
    document.getElementById('result').innerHTML = '<p class="text-red-600">Lỗi! Thử lại.</p>';
  }
};

function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}

// === LEADERBOARD ===
async function showLeaderboard() {
  document.getElementById('examScreen').classList.add('hidden');
  document.getElementById('leaderboardScreen').classList.remove('hidden');
  const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=leaderboard`);
  const data = await res.json();
  const tbody = document.getElementById('leaderboardBody');
  tbody.innerHTML = data.length ? data.map((s, i) => `
    <tr class="${i%2===0 ? 'bg-gray-50' : ''}">
      <td class="p-3 font-bold text-green-700">${i+1}</td>
      <td class="p-3">${s.name}</td>
      <td class="p-3 text-center font-bold">${s.total.toFixed(1)}</td>
      <td class="p-3 text-center">${s.count}</td>
      <td class="p-3 text-center">${s.avg}</td>
    </tr>
  `).join('') : '<tr><td colspan="5" class="p-6 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
}

function hideLeaderboard() {
  document.getElementById('leaderboardScreen').classList.add('hidden');
  document.getElementById('examScreen').classList.remove('hidden');
}

function restartExam() {
  loadQuestion();
  document.getElementById('result').innerHTML = '';
  document.getElementById('transcript').textContent = 'Nhấn "Bắt đầu ghi âm" để nói...';
  document.getElementById('startBtn').disabled = false;
  resetTimer();
}

// === KHỞI ĐỘNG ===
initApp();
</script>
</body>
</html>