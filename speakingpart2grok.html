<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCE Speaking Part 2 - LIME</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); min-height: 100vh; }
    .fade-in { animation: fadeIn 0.5s ease-in; } @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .images { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .images img { width: 45%; min-width: 200px; max-width: 400px; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; }
    .timer { font-size: 1.5em; font-weight: bold; color: #dc2626; }
    .small-btn { @apply px-3 py-1 text-sm font-medium bg-gray-600 hover:bg-gray-700 text-white rounded-lg; }
    .placeholder-img { background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body class="p-4">
<div id="app" class="max-w-4xl mx-auto">
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen fade-in">
    <div class="bg-white rounded-2xl shadow-2xl p-8 mt-8">
      <div class="text-center mb-8">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-32 h-32 mx-auto mb-4 object-contain">
        <h1 class="text-4xl font-bold text-green-700 mb-2">Trung T√¢m Ti·∫øng Anh LIME</h1>
        <p class="text-green-600 text-lg">Hotline: 0976222792</p>
        <div class="mt-4 h-1 w-32 bg-green-500 mx-auto rounded"></div>
      </div>
      <div class="bg-green-50 rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-green-800 mb-4">FCE SPEAKING PART 2</h2>
        <p class="text-green-700">So s√°nh 2 ·∫£nh + tr·∫£ l·ªùi c√¢u h·ªèi trong 1 ph√∫t</p>
        <p class="text-green-700">AI ch·∫•m theo FCE rubric</p>
        <p class="text-green-700">Leaderboard: T·ªïng ƒëi·ªÉm + Trung b√¨nh</p>
      </div>
      <label class="block text-green-800 font-semibold mb-2">M√£ h·ªçc sinh *</label>
      <input type="text" id="studentCode" class="w-full px-4 py-3 border-2 border-green-300 rounded-lg uppercase text-lg" placeholder="VD: HS001" />
      <button onclick="verifyStudent()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg shadow-lg">
        X√ÅC NH·∫¨N & B·∫ÆT ƒê·∫¶U
      </button>
    </div>
  </div>

  <!-- EXAM SCREEN -->
  <div id="examScreen" class="hidden min-h-screen pb-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
          <div>
            <h1 class="text-2xl font-bold text-green-700">FCE Speaking Part 2</h1>
            <p class="text-green-600 text-sm">Xin ch√†o, <span id="studentName"></span>!</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">M√£: <span id="headerCode"></span></p>
          <p class="text-sm text-gray-600">M·ª•c ti√™u: <span id="targetLevel"></span></p>
          <div class="timer" id="timer">01:00</div>
        </div>
      </div>
      <div class="mt-4 flex gap-2 justify-end">
        <button onclick="showLeaderboard()" class="small-btn">B·∫£ng x·∫øp h·∫°ng</button>
        <button onclick="logout()" class="small-btn">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6 fade-in">
      <div class="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white px-6 py-4 rounded-t-xl -mx-8 -mt-8 mb-6">
        <h2 class="text-2xl font-bold">So s√°nh 2 b·ª©c tranh</h2>
      </div>
      <div class="images mb-6" id="images"></div>
      <p class="text-lg font-semibold text-indigo-800 mb-6 p-4 bg-indigo-50 rounded-lg" id="question"></p>

      <div class="flex gap-3 flex-wrap mb-4">
        <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">B·∫Øt ƒë·∫ßu ghi √¢m</button>
        <button id="stopBtn" disabled class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg">D·ª´ng</button>
        <button id="submitBtn" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">G·ª≠i AI ch·∫•m</button>
      </div>

      <div class="mt-6 p-4 bg-gray-50 rounded-lg" id="transcript">Nh·∫•n "B·∫Øt ƒë·∫ßu ghi √¢m" ƒë·ªÉ n√≥i...</div>
      <div id="result" class="mt-6"></div>

      <label class="flex items-center gap-2 mt-6 text-gray-700">
        <input type="checkbox" id="saveAudio" checked /> L∆∞u audio?
      </label>

      <button onclick="restartExam()" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">
        L√†m b√†i m·ªõi
      </button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardScreen" class="hidden min-h-screen pb-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-green-700">B·∫¢NG X·∫æP H·∫†NG</h1>
      <button onclick="hideLeaderboard()" class="small-btn">Quay l·∫°i</button>
    </div>
    <div class="bg-white rounded-2xl shadow-2xl p-6 overflow-x-auto">
      <table class="w-full table-auto border-collapse">
        <thead>
          <tr class="bg-green-100 text-green-800">
            <th class="p-3 text-left">H·∫°ng</th>
            <th class="p-3 text-left">H·ªçc sinh</th>
            <th class="p-3 text-center">T·ªïng ƒëi·ªÉm</th>
            <th class="p-3 text-center">S·ªë b√†i</th>
            <th class="p-3 text-center">Trung b√¨nh</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// === C·∫§U H√åNH ===
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYlENWgtwewFblT0mdbrK-TuN8S1QEI0y_MgoqAmNy6okRTHLbmV8gIjgIFHJdaSGlrg/exec';

let student = {}, recognition, mediaRecorder, audioBlob, transcript = '', currentQuestion = '', startTime, timerInterval, timeLeft = 60;

// === 25 C·∫∂P ·∫¢NH (d√πng Pexels - ·ªïn ƒë·ªãnh h∆°n Unsplash) ===
const questions = [
  {
    img1: "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1181622/pexels-photo-1181622.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why teamwork might be important in these situations."
  },
  {
    img1: "https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3769021/pexels-photo-3769021.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be feeling."
  },
  {
    img1: "https://images.pexels.com/photos/1327430/pexels-photo-1327430.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3822843/pexels-photo-3822843.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what kind of music the people might be listening to."
  },
  {
    img1: "https://images.pexels.com/photos/869258/pexels-photo-869258.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1365425/pexels-photo-1365425.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why the people might have chosen these activities."
  },
  {
    img1: "https://images.pexels.com/photos/1926769/pexels-photo-1926769.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1036623/pexels-photo-1036623.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be feeling about their appearance."
  },
  {
    img1: "https://images.pexels.com/photos/1729931/pexels-photo-1729931.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1157557/pexels-photo-1157557.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what the people might be celebrating."
  },
  {
    img1: "https://images.pexels.com/photos/544965/pexels-photo-544965.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1127119/pexels-photo-1127119.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why the people might be using these forms of transport."
  },
  {
    img1: "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1181467/pexels-photo-1181467.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how technology might be helping the people in their work."
  },
  {
    img1: "https://images.pexels.com/photos/5632382/pexels-photo-5632382.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1005638/pexels-photo-1005638.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what the people might be buying and why."
  },
  {
    img1: "https://images.pexels.com/photos/5212317/pexels-photo-5212317.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/5905857/pexels-photo-5905857.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be learning in these situations."
  },
  {
    img1: "https://images.pexels.com/photos/1264210/pexels-photo-1264210.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1194420/pexels-photo-1194420.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why the people might be taking these photos."
  },
  {
    img1: "https://images.pexels.com/photos/3766180/pexels-photo-3766180.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/6551415/pexels-photo-6551415.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be relaxing."
  },
  {
    img1: "https://images.pexels.com/photos/1441151/pexels-photo-1441151.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1130857/pexels-photo-1130857.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the weather might be affecting the people."
  },
  {
    img1: "https://images.pexels.com/photos/3338681/pexels-photo-3338681.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1251208/pexels-photo-1251208.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why the people might have chosen these foods."
  },
  {
    img1: "https://images.pexels.com/photos/1552242/pexels-photo-1552242.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3775164/pexels-photo-3775164.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what the advantages might be of these activities."
  },
  {
    img1: "https://images.pexels.com/photos/1010657/pexels-photo-1010657.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/2739666/pexels-photo-2739666.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why the people might prefer these places."
  },
  {
    img1: "https://images.pexels.com/photos/3747435/pexels-photo-3747435.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3825517/pexels-photo-3825517.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what the people might be reading about."
  },
  {
    img1: "https://images.pexels.com/photos/1648387/pexels-photo-1648387.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3768114/pexels-photo-3768114.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why these moments might be important."
  },
  {
    img1: "https://images.pexels.com/photos/3778403/pexels-photo-3778403.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/2247678/pexels-photo-2247678.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be expressing themselves."
  },
  {
    img1: "https://images.pexels.com/photos/1761279/pexels-photo-1761279.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1402850/pexels-photo-1402850.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how being in nature might affect the people."
  },
  {
    img1: "https://images.pexels.com/photos/3184465/pexels-photo-3184465.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/5212339/pexels-photo-5212339.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people are communicating."
  },
  {
    img1: "https://images.pexels.com/photos/4498185/pexels-photo-4498185.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/5731796/pexels-photo-5731796.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why people might enjoy these activities with animals."
  },
  {
    img1: "https://images.pexels.com/photos/3184436/pexels-photo-3184436.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/1643383/pexels-photo-1643383.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say what challenges the people might face in these environments."
  },
  {
    img1: "https://images.pexels.com/photos/1267697/pexels-photo-1267697.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/2774556/pexels-photo-2774556.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say why these forms of entertainment might appeal to people."
  },
  {
    img1: "https://images.pexels.com/photos/1595385/pexels-photo-1595385.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    img2: "https://images.pexels.com/photos/3184423/pexels-photo-3184423.jpeg?auto=compress&cs=tinysrgb&w=400&h=300",
    question: "Compare the two pictures and say how the people might be feeling about their achievements."
  }
];

// === KH·ªûI ƒê·ªòNG ===
function initApp() {
  console.log('üöÄ initApp() ƒë∆∞·ª£c g·ªçi');
  
  // KH√îNG t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p l·∫°i, lu√¥n y√™u c·∫ßu nh·∫≠p m√£
  localStorage.removeItem('speakingStudent');
  student = {};
  showLogin();
}

function showLogin() {
  console.log('üìù Hi·ªÉn th·ªã m√†n h√¨nh login');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('examScreen').classList.add('hidden');
  document.getElementById('leaderboardScreen').classList.add('hidden');
  document.getElementById('studentCode').value = '';
  document.getElementById('studentCode').focus();
}

function showExam() {
  console.log('üìö Hi·ªÉn th·ªã m√†n h√¨nh thi');
  console.log('Student hi·ªán t·∫°i:', student);
  
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('examScreen').classList.remove('hidden');
  document.getElementById('leaderboardScreen').classList.add('hidden');
  
  document.getElementById('studentName').textContent = student.name || 'N/A';
  document.getElementById('headerCode').textContent = student.code || 'N/A';
  document.getElementById('targetLevel').textContent = student.target || 'B1';
  
  loadQuestion();
  resetTimer();
}

// === ƒêƒÇNG NH·∫¨P ===
async function verifyStudent() {
  const input = document.getElementById('studentCode');
  let code = input.value;
  
  if (!code) {
    alert('Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh!');
    input.focus();
    return;
  }
  
  code = code.trim().toUpperCase();
  console.log('üîç ƒêang x√°c th·ª±c m√£:', code);
  
  const btn = document.querySelector('#loginScreen button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> ƒêang x√°c nh·∫≠n...';

  try {
    const url = `${GOOGLE_SCRIPT_URL}?action=verifySpeaking&code=${encodeURIComponent(code)}`;
    console.log('üì° G·ªçi API:', url);
    
    const res = await fetch(url);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    console.log('‚úÖ API tr·∫£ v·ªÅ:', data);
    
    if (data.exists) {
      student = { 
        code: code,
        name: data.name, 
        target: data.target || 'B1' 
      };
      console.log('üíæ L∆∞u student:', student);
      localStorage.setItem('speakingStudent', JSON.stringify(student));
      
      btn.innerHTML = '‚úì Th√†nh c√¥ng!';
      setTimeout(() => showExam(), 500);
    } else {
      alert(`‚ùå Kh√¥ng t√¨m th·∫•y m√£ h·ªçc sinh: ${code}\n\nVui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c li√™n h·ªá gi√°o vi√™n.`);
      input.focus();
      input.select();
    }
  } catch (err) {
    console.error('‚ùå L·ªói:', err);
    alert(`L·ªói k·∫øt n·ªëi!\n\n${err.message}\n\nVui l√≤ng:\n‚Ä¢ Ki·ªÉm tra Internet\n‚Ä¢ Th·ª≠ l·∫°i sau\n‚Ä¢ Li√™n h·ªá admin n·∫øu l·ªói li√™n t·ª•c`);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function logout() { 
  console.log('üëã ƒêƒÉng xu·∫•t');
  localStorage.removeItem('speakingStudent'); 
  student = {};
  location.reload(); 
}

// === T·∫¢I C√ÇU H·ªéI ===
function loadQuestion() {
  const q = questions[Math.floor(Math.random() * questions.length)];
  document.getElementById('images').innerHTML = `
    <img src="${q.img1}" alt="1" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Found'; this.classList.add('placeholder-img')">
    <img src="${q.img2}" alt="2" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Found'; this.classList.add('placeholder-img')">
  `;
  document.getElementById('question').textContent = q.question;
  currentQuestion = q.question;
}

// === TIMER ===
function startTimer() {
  timeLeft = 60;
  document.getElementById('timer').textContent = '01:00';
  document.getElementById('timer').className = 'timer text-green-600';
  timerInterval = setInterval(() => {
    timeLeft--;
    const display = `00:${timeLeft.toString().padStart(2, '0')}`;
    document.getElementById('timer').textContent = display;
    if (timeLeft <= 0) {
      document.getElementById('timer').textContent = '00:00';
      document.getElementById('timer').className = 'timer text-red-600 font-bold';
      document.getElementById('timer').innerHTML += ' <span class="text-sm">(Qu√° gi·ªù!)</span>';
      clearInterval(timerInterval);
    }
  }, 1000);
}
function resetTimer() { clearInterval(timerInterval); document.getElementById('timer').textContent = '01:00'; document.getElementById('timer').className = 'timer text-green-600'; }

// === GHI √ÇM ===
document.getElementById('startBtn').onclick = () => {
  transcript = '';
  document.getElementById('transcript').textContent = 'ƒêang nghe... (N√≥i ti·∫øng Anh!)';
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  document.getElementById('submitBtn').disabled = true;
  startTime = Date.now();
  startTimer();

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-GB';
  recognition.interimResults = true;
  recognition.continuous = true;
  recognition.onresult = e => {
    transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
    document.getElementById('transcript').textContent = transcript;
  };
  recognition.start();

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(chunks, { type: 'audio/webm' });
      document.getElementById('submitBtn').disabled = false;
    };
    mediaRecorder.start();
  }).catch(() => {
    alert('C·∫ßn c·∫•p quy·ªÅn micro!');
    document.getElementById('startBtn').disabled = false;
  });
};

document.getElementById('stopBtn').onclick = () => {
  recognition?.stop();
  mediaRecorder?.stop();
  clearInterval(timerInterval);
  document.getElementById('stopBtn').disabled = true;
  document.getElementById('submitBtn').disabled = false;
};

// === G·ª¨I + L·∫§Y K·∫æT QU·∫¢ ===
document.getElementById('submitBtn').onclick = async () => {
  const duration = Math.round((Date.now() - startTime) / 1000);
  const saveAudio = document.getElementById('saveAudio').checked;

  let audioBase64 = '';
  if (saveAudio && audioBlob) {
    audioBase64 = await blobToBase64(audioBlob);
  }

  const dataToSend = {
    action: 'submitSpeaking',
    studentCode: student.code,
    studentName: student.name,
    targetLevel: student.target,
    transcript,
    question: currentQuestion,
    duration,
    audioBase64
  };

  document.getElementById('result').innerHTML = '<div class="spinner mr-2"></div> ƒêang g·ª≠i...';

  try {
    await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(dataToSend)
    });

    setTimeout(async () => {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLatestScore&code=${student.code}`);
      const ai = await res.json();
      document.getElementById('result').innerHTML = `
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
          <h3 class="text-xl font-bold text-green-700 mb-2">K·∫øt qu·∫£ AI</h3>
          <p><strong>ƒêi·ªÉm:</strong> ${ai.score || 'N/A'}/10 | <strong>CEFR:</strong> ${ai.cefrEquivalent || 'N/A'}</p>
          <p><strong>Ph·∫£n h·ªìi:</strong> ${ai.feedback || 'ƒêang x·ª≠ l√Ω...'}</p>
        </div>
      `;
      showLeaderboard();
    }, 3000);
  } catch {
    document.getElementById('result').innerHTML = '<p class="text-red-600">L·ªói! Th·ª≠ l·∫°i.</p>';
  }
};

function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}

// === LEADERBOARD ===
async function showLeaderboard() {
  document.getElementById('examScreen').classList.add('hidden');
  document.getElementById('leaderboardScreen').classList.remove('hidden');
  const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=leaderboard`);
  const data = await res.json();
  const tbody = document.getElementById('leaderboardBody');
  tbody.innerHTML = data.length ? data.map((s, i) => `
    <tr class="${i%2===0 ? 'bg-gray-50' : ''}">
      <td class="p-3 font-bold text-green-700">${i+1}</td>
      <td class="p-3">${s.name}</td>
      <td class="p-3 text-center font-bold">${s.total.toFixed(1)}</td>
      <td class="p-3 text-center">${s.count}</td>
      <td class="p-3 text-center">${s.avg}</td>
    </tr>
  `).join('') : '<tr><td colspan="5" class="p-6 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
}

function hideLeaderboard() {
  document.getElementById('leaderboardScreen').classList.add('hidden');
  document.getElementById('examScreen').classList.remove('hidden');
}

function restartExam() {
  loadQuestion();
  document.getElementById('result').innerHTML = '';
  document.getElementById('transcript').textContent = 'Nh·∫•n "B·∫Øt ƒë·∫ßu ghi √¢m" ƒë·ªÉ n√≥i...';
  document.getElementById('startBtn').disabled = false;
  resetTimer();
}

// === KH·ªûI ƒê·ªòNG ===
initApp();
</script>
</body>
</html>